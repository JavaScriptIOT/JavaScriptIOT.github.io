<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/danfojs@1.1.2/lib/bundle.js"></script>
    <script src="https://cdn.bootcss.com/vConsole/3.2.0/vconsole.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jschardet/3.0.0/jschardet.min.js"></script>
    
    <title>Document</title>
</head>

<body>
    <h2>储能站投资回报计算</h2>
    <div><a>变压器容量功率:</a><input type="text" id="transformCapacity" value="4450"><a>KW</a></div>
    <div><a>储能站个数:</a><input type="text" id="packNumber" value="15"></div>
    <input type="file" id="file" name="file">
    <button id="simulate">计算</button>
    <div id="div1"></div>
    <div id="div2"></div>
    <div id="div3"></div>
    <div id="div4"></div>
    <button id="download">下载</button>


<!-- 一键计算节能空间——填写 -->
<div class="g_c3one">
    <div class="g_c3onetan">
        <h2 class="g_word2">空压机节能空间计算</h2>
        <div class="g_c3onecen">
            <div class="g_c3onenr clearfix">
                <div class="g_c3onenr2 fl">工频空压机数量:</div>
                <div class="g_c3onenr3 fl"><input type="text" id="type_a">台</div>
                <div class="g_c3onenr4 fl"></div>
            </div>
            <div class="g_c3onenr clearfix">
                <div class="g_c3onenr2 fl">工频总功率:</div>
                <div class="g_c3onenr3 fl"><input type="text" id="type_b">KW</div>
                <div class="g_c3onenr4 fl"></div>
            </div>
            <div class="g_c3onenr clearfix">
                <div class="g_c3onenr2 fl">工频平均加载率:</div>
                <div class="g_c3onenr3 fl"><input type="text" id="type_c">%</div>
                <div class="g_c3onenr4 fl"></div>
            </div>
            <div class="g_c3onenr clearfix">
                <div class="g_c3onenr2 fl">变频空压机数量:</div>
                <div class="g_c3onenr3 fl"><input type="text" id="type_d">台</div>
                <div class="g_c3onenr4 fl"></div>
            </div>
            <div class="g_c3onenr clearfix">
                <div class="g_c3onenr2 fl">变频总功率:</div>
                <div class="g_c3onenr3 fl"><input type="text" id="type_e">KW</div>
                <div class="g_c3onenr4 fl"></div>
            </div>
            <div class="g_c3onenr clearfix">
                <div class="g_c3onenr2 fl">变频平均负载率:</div>
                <div class="g_c3onenr3 fl"><input type="text" id="type_f">%</div>
                <div class="g_c3onenr4 fl"></div>
            </div>
        </div>
        <button id="air">计算</button>
    </div>
</div>

    <script>
        var vConsole = new VConsole();

        window.addEventListener('load', function () {
            alert("It's loaded!")
        })

        const inputFile = document.querySelector('#file')
        const downloadFile = document.querySelector('#download')
        const simulation  = document.querySelector('#simulate')
        var downloadCSV = null;

        downloadFile.addEventListener("click", async () => {
            if (downloadCSV != null)
                dfd.toCSV(downloadCSV, { fileName: "charge.csv", download: true });
        })

        simulation.addEventListener("click", async () => {
            if(inputFile == null) return
            const file = inputFile.files[0]
            const fileName = file.name
            const extension = fileName.substring(fileName.lastIndexOf('.') + 1);
            var inputValue = document.getElementById("packNumber").value;
            var pack_number = parseInt(inputValue)
            inputValue = document.getElementById("transformCapacity").value;
            var transform_capacity = parseInt(inputValue)
            const powerpack = {
                pack_max_capacity: 215,
                pack_max_power: 100,
                pack_number: pack_number,
                transform_capacity: transform_capacity * 0.95,
                charge_efficiency: 0.94,
                dicharge_efficiency: 0.94,
                Totalpower: 0
            }

            var powerpack_state = {
                pack_current_power: 0,
                pack_momey_gain: 0
            }

            const pack_charge_rate_night = 0.33

            const powerprice = {
                peak_time: {
                    time: [{
                        start_hour: 9,
                        end_hour: 11
                    }, {
                        start_hour: 15,
                        end_hour: 17
                    },], price: 1.009899971
                },
                valley_time: {
                    time: [{
                        start_hour: 0,
                        end_hour: 8
                    }, {
                        start_hour: 11,
                        end_hour: 13
                    },], price: 0.118399996

                }

            }

            function charge(user_power, rate) {
                if (user_power < 0) user_power = 0;
                total = powerpack.pack_max_power * powerpack.pack_number
                charge_power = total * rate
                if (charge_power > powerpack.transform_capacity - user_power)
                    charge_power = powerpack.transform_capacity - user_power
                if (powerpack_state.pack_current_power + charge_power * 0.25 * powerpack.charge_efficiency > powerpack.pack_number * powerpack.pack_max_capacity)
                    charge_power = (powerpack.pack_number * powerpack.pack_max_capacity - powerpack_state.pack_current_power) / powerpack.charge_efficiency * 4;
                dellta = charge_power * 0.25
                //console.log("over" + (powerpack.transform_capacity - charge_power - user_power))
                powerpack_state.pack_current_power += dellta * powerpack.charge_efficiency//* powerpack.charge_efficiency; //for 0.25 hour
                powerpack_state.pack_momey_gain -= dellta * powerprice.valley_time.price;
                powerpack.Totalpower = charge_power + user_power;
            }

            function discharge(user_power) {
                if (user_power < 0) user_power = 0;
                total = powerpack.pack_max_power * powerpack.pack_number
                discharge_power = total
                if (discharge_power > user_power)
                    discharge_power = user_power
                if (powerpack_state.pack_current_power - discharge_power * 0.25 / powerpack.dicharge_efficiency < 0)
                    discharge_power = powerpack_state.pack_current_power * powerpack.dicharge_efficiency * 4
                dellta = discharge_power * 0.25
                //console.log(dellta)
                powerpack_state.pack_current_power -= dellta / powerpack.dicharge_efficiency //for 0.25 hour;
                powerpack_state.pack_momey_gain += dellta * powerprice.peak_time.price;
                powerpack.Totalpower = user_power - discharge_power;
            }

            function keep(user_power) {
                powerpack.Totalpower = user_power ;
            }

            function work(df) {
//                df = df.head(10000)
//                df = df.tail(3000)

                df.sortValues("日期", { ascending: true, inplace: true })

                var powerdata = df.loc({ columns: ['日期', '瞬时有功'] })
                powerdata = powerdata.dropNa({ axis: 1 })
                var d = new Array(powerdata.index.length).fill(0.1)
                powerdata.addColumn('储能', d, { inplace: true })
                powerdata.addColumn('收入', d, { inplace: true })
                powerdata.addColumn('总功率', d, { inplace: true })

                function work(col) {
                    const date = new Date(col[0].replace('\t', ''))
                    const hour = date.getHours();
                    const power = col[1];
                    if (hour >= powerprice.valley_time.time[0].start_hour && hour < powerprice.valley_time.time[0].end_hour)
                        charge(power, pack_charge_rate_night)
                    else if (hour >= powerprice.valley_time.time[1].start_hour && hour < powerprice.valley_time.time[1].end_hour)
                        charge(power, 0.9)
                    else if (hour >= powerprice.peak_time.time[0].start_hour && hour < powerprice.peak_time.time[0].end_hour)
                        discharge(power)
                    else if (hour >= powerprice.peak_time.time[1].start_hour && hour < powerprice.peak_time.time[1].end_hour)
                        discharge(power)
                    else 
                        keep(power)
                    // console.log(col[0])
                    // console.log(hour)
                    // console.log(powerpack_state.pack_current_power)
                    // console.log(powerpack_state.pack_momey_gain)
                    // console.log(powerpack.Totalpower)
                    return [col[0], col[1], powerpack_state.pack_current_power, powerpack_state.pack_momey_gain, powerpack.Totalpower]
                }
                //console.log(powerdata)
                powerdata = powerdata.apply(work, { axis: 1 })
                powerdata = powerdata.addColumn('month', powerdata['日期'].apply( (x) => {
                    const date = new Date(x.replace('\t', ''))
                    const month = date.getMonth() + 1;
                    return month
                }));
                powerdata = powerdata.addColumn('date', powerdata['日期'].apply( (x) => {
                    const date = new Date(x.replace('\t', ''))
                    const day = date.getDate();
                    return day
                }));
                powerdata = powerdata.addColumn('weekday', powerdata['日期'].apply( (x) => {
                    const date = new Date(x.replace('\t', ''))
                    const day = date.getDay();
                    return day
                }));
                powerdata.plot("div1").table() //display csv as table
                downloadCSV = powerdata
                new_df = powerdata.setIndex({ column: '日期', drop: true }); //resets the index to Date column
                console.log(new_df)
                // new_df.head().print()
                new_df.plot("div2").line({
                    config: {
                        columns: ["瞬时有功", "储能", "收入", "总功率"]
                    }
                })  //makes a timeseries plot

                let group_df = powerdata
                group_df = group_df.drop({ columns: ["日期", "date","weekday"], inplace: false })
                new_df_2 = group_df.groupby(["month"]).max()
                new_df_2.plot("div3").table() 
                max_power_all_momey =  new_df_2['总功率_max'].sum()* 40
                max_power_current_momey =  new_df_2['瞬时有功_max'].sum() * 40
                total_money_gain = new_df_2["收入_max"].max()
                transform_capacity_momey =  transform_capacity * 30   * new_df_2.index.length
                total_cost =  pack_number  * 400000 
                console.log("储能总利润" + total_money_gain )
                console.log( "储能容量费用" + max_power_all_momey)
                console.log("原始容量费用"  + max_power_current_momey)
                console.log( "固定容量费用" +  transform_capacity_momey )
                //console.log("可变容量总收益"+  (total_money_gain -  max_power_all_momey + max_power_current_momey)) 
               // console.log("可变容量费用差"+  (total_money_gain + max_power_current_momey - transform_capacity_momey)) 
                console.log("设备成本"+ total_cost ) 
                console.log("固定容量投资回报率"+ total_cost /  ((total_money_gain + max_power_current_momey - transform_capacity_momey) /11 * 12) )
                console.log("可变容量投资回报率"+ total_cost /  ((total_money_gain - max_power_all_momey + max_power_current_momey)/11 * 12)) 

                //document.getElementById('div4').appendChild(powerpack_state.pack_momey_gain);
            }
            if(extension == "xls") {
                dfd.readExcel(file).then((df) => {
                    work(df) 
                }).catch(err => {
                    console.log(err);
                })
            }
            else if (extension == "csv") {
                const reader = new FileReader();
                reader.readAsDataURL(file)  // 获取txt文件的base64码
                reader.onload = function (evt) {
                    buffer = evt.target.result
                    ret = jschardet.detect(atob(buffer.split(';base64,')[1]));
                    console.log(ret)
                    dfd.readCSV(file, {encoding:ret.encoding}).then((df) => {
                        work(df) 
                    }).catch(err => {
                        console.log(err);
                    })
                };
            }
            else {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                alert("File is not support.")
            } 
        })

        function cal(a,b,c,d,e,f){
            c = (parseInt(c)/100).toFixed(1);
            console.log(c)
            f = (parseInt(f)/100).toFixed(1);
            var g = (1 - c).toFixed(1);
            var h = d - f * d;
                h=Math.round(h*100)/100;
            console.log(g);
            console.log(h);
            console.log(( g * 0.45 * b + h * 0.1 * e / d ) / (parseInt(b)+parseInt(e)));
            return (( g * 0.45 * b + h * 0.1 * e / d )/(parseInt(b)+parseInt(e))).toFixed(2);
            // return ( g * 0.45 * b + h * 0.1 * e / d )/(b+e);
        }
        const air = document.querySelector('#air')
        air.addEventListener("click", async () => {
            var a = document.getElementById("type_a").value;
            var b = document.getElementById("type_b").value;
            var c = document.getElementById("type_c").value;
            var d = document.getElementById("type_d").value;
            var e = document.getElementById("type_e").value;
            var f = document.getElementById("type_f").value;
            if(!a){
                alert('请输入工频空压机数量');
                return;
            }
            if(!b){
                alert('请输入工频总功率');
                return;
            }
            if(!c){
                alert('请输入工频平均加载率');
                return;
            }
            if(c < 1 || c > 100){
                alert('工频平均加载率应大于等于1%且小于等于100%');
                return;
            }
            if(!d){
                alert('请输入变频空压机数量');
                return;
            }
            if(!e){
                alert('请输入变频总功率');
                return;
            }
            if(!f){
                alert('请输入变频平均负载率');
                return;
            }
            if(f < 1 || f > 100){
                alert('变频平均负载率应大于等于1%且小于等于100%');
                return;
            }
            var vals = cal(a,b,c,d,e,f);
            alert('空压站节能空间' + (vals * 100).toFixed(2) + "%");

        })

    </script>
</body>

</html>